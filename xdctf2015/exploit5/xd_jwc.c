#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<string.h>
#include<fcntl.h>

typedef (* pcalc_score)(void*, int); 
int calc_score(void *p,  int is_del);

#pragma pack(8)
typedef struct _exam_info
{
    int  exam_class;
    unsigned int  content_length;
    unsigned int  content_buf_length;
    char *exam_contents;
    pcalc_score calc_score;
    char l[70];
}exam_info, *pexam_info;

typedef struct _mem_info
{
    char mem_name[17];
    char self_info[201];
    pexam_info self_exam_info[3];
}mem_info, *pmem_info;

int is_register = 0;
pmem_info persion_info = NULL;

//three
int std_read(unsigned char *buf, unsigned int count)
{
    int idx = 0, i = 0;
    unsigned char c_in;

    for(i = 0; i <= count; i++){
       if( read(STDIN_FILENO, (void *)&c_in, 1) < 0 ){
           return -1;
       }
       if( c_in == '\n' ){
           *(buf + i) = 0;
           return i;
       }

       *(buf + i) = c_in;
    }
    buf[i-1] = 0;

    return i-1;
}

int std_atoi(char *buf, unsigned int length)
{
    int i;

    for(i = 0; i < length; i++){
        if( buf[i] == 0 )
            break;
        if( (buf[i] < '0') || (buf[i] > '9') ){
            return -1;
        }
    }

    return atoi(buf);
}

int output_banner()
{
    puts("welcome to xidian jwc,here you can");
    return 0;
}

int output_choice()
{
    puts("1.register");
    puts("2.take an exam");
    puts("3.show your scores");
    puts("4.show your info");
    puts("5.resit");
    //puts("6.to cheat");
    puts("6.exit");

    return 0;
}

int do_register()
{
    if( is_register ){
        puts("you already registered!");
        return -1;
    }

    persion_info = malloc( sizeof(mem_info) );
    if( !persion_info )
        goto cleanup;
    memset( persion_info, 0, sizeof(mem_info) );

    puts("your name, no more than 16 chars");

    if( std_read( persion_info->mem_name, 16 )<0 ){
        goto cleanup;
    }

    puts("with no more than 200 chars to introduce yourself");
    
    if( std_read( persion_info->self_info, 200 )<0 ){
        goto cleanup;
    } 

    is_register = 1;
    
    puts("successfully registered!\n");

    return 0;

cleanup:  
    puts("something wrong...\n");
    if( is_register )
        is_register = 0;
    if( persion_info ){
        free( persion_info );
        persion_info = NULL;
    }
    return -1;
}

int show_info()
{
    if( is_register ){
        printf("name: %s\n", persion_info->mem_name);
        printf("self-introduction: %s\n\n", persion_info->self_info);
    }else{
        puts("you have to register firstly\n");
    }
    return 0;
}

int do_exit()
{
    exit(0);
}

int c_idx;

int do_read_content(FILE *fp, int length)
{
    char content[90] = {0};

    c_idx = 0;
    
    while( (c_idx += std_read(content+c_idx, length-c_idx)) != length );
    
    //if( dup2(fp, 1)<0 )
    //    puts("something wrong...\n");

    fprintf(fp, "%s", content);
    //write(fp, content, length);

    return 0;
}

int child_read_content(FILE *fp, int length)
{
    setvbuf(fp, NULL, _IOLBF, 0);
    do_read_content(fp, length);
    //puts("this is a test");
    exit(0);
}

int take_exam()
{
    int idx, length, i = 0;
    FILE *fp = NULL;
    int e_idx = 0;
    pid_t  pid, f_pid;
    char s_idx[2] = {0}, l_essay[4] = {0};
    char filename[25] = {0};
    char *content = NULL;
    pexam_info  pe_info = NULL;

    if( !is_register ){
        puts("you have to register firstly\n");
        return 0;
    }


    puts("which exam do you want to take?");
    puts("1.math");
    puts("2.english");
    puts("3.dota");

    std_read(s_idx, 1);
    idx = std_atoi(s_idx, 1);

    switch(idx){
    case 1:
        if( persion_info->self_exam_info[0] ){
            if( persion_info->self_exam_info[0]->content_length ){
                puts("you have finished the exam of math\n");
                goto cleanup;
            }else{
                pe_info = persion_info->self_exam_info[0]; 
            }
        }
        e_idx = 1;
        break;

    case 2:
        if( persion_info->self_exam_info[1] ){
            if( persion_info->self_exam_info[1]->content_length ){
                puts("you have finished the exam of math\n");
                goto cleanup;
            }else{
                pe_info = persion_info->self_exam_info[1]; 
            }
        }
        e_idx = 2;
        break;

    case 3:
        if( persion_info->self_exam_info[2] ){
            if( persion_info->self_exam_info[2]->content_length ){
                puts("you have finished the exam of math\n");
                goto cleanup;
            }else{
                pe_info = persion_info->self_exam_info[2]; 
            }
        }
        e_idx = 3;
        break;

    default:
        goto cleanup;

    }
    
    if( !pe_info ){
        pe_info = malloc( sizeof(exam_info) );
        if( !pe_info )
            goto cleanup;
        memset(pe_info, 0, sizeof(exam_info) );
    
        persion_info->self_exam_info[e_idx-1] = pe_info;
        pe_info->exam_class = e_idx;
        pe_info->calc_score = calc_score;
    }

    puts("OK...first of all, write an essay of no more than 104 words~");
    puts("length of your essay?");
    std_read(l_essay, 3);
    length = std_atoi(l_essay, 3);

    if( (length > 104) || (length <= 0) ){
        goto cleanup;
    }

    f_pid = getpid();
    sprintf(filename, "%d", f_pid);
    if( (fp = fopen(filename, "w+")) == NULL ){
        goto cleanup;
    }

    puts("OK");
    if( unlink(filename)<0 )
        goto cleanup;

    if( (pid = fork())<0 ){
        goto cleanup;
    }else if(pid ==0){ //child
        child_read_content(fp, length);
    }else{             //parent
        wait(pid);
    }

    //sleep(1);

    content = malloc(length);
    if( !content )
        goto cleanup;
    memset(content, 0, length);

    if( fseek(fp, SEEK_SET, 0) < 0)
        perror("fseek");
    
    while( fread(content+i, 1, 1, fp)>0 )
        i++;

    pe_info->content_buf_length = length;
    pe_info->content_length = i;
    
    //
    //
    pe_info->exam_contents = content;
    //if( !pe_info->exam_contents )
    //    goto cleanup;
    //memset(pe_info->exam_contents, 0, pe_info->content_length);
    //memcpy(pe_info->exam_contents, content, pe_info->content_length);

    //printf("contents:%d  %s\n",pe_info->content_length, pe_info->exam_contents);
    puts("you have finished the exam~\n");
    
    //free(content);
    fclose(fp);

    return 0;

cleanup:
    puts("something wrong...\n");
    if( content )
        free(content);
    if( pe_info ){
        if( pe_info->exam_contents )
            free(pe_info->exam_contents);
        free(pe_info);
    }
    if( e_idx )
        persion_info->self_exam_info[ e_idx-1 ] = NULL;
    if( fp )
        fclose(fp);

    return -1;
}

int calc_score(void *p,  int is_del)
{
    int score = 0, i = 0;
    pexam_info pe_info = (pexam_info)p;

    switch( pe_info->exam_class ){
    case 1:
        for(; i<pe_info->content_length; i++)
            score += pe_info->exam_contents[i];
       
        score %= 100;

        break;
    case 2:
        for(; i<pe_info->content_length; i++)
            score *= pe_info->exam_contents[i];
       
        score %= 100;
        
        break;
    case 3:   
        for(; i<pe_info->content_length; i++)
            score ^= pe_info->exam_contents[i];
       
        score %= 100;
        break;     
    }

    if( is_del && (score<60) )
       free(pe_info->exam_contents); 

    return score;
}

int show_score()
{
    if( !is_register ){
        puts("you have to register firstly\n");
        return -1;
    }
    persion_info->self_exam_info[ 0 ] ? \
        printf( "math: %d\n", persion_info->self_exam_info[0]-> \
        calc_score((void *)persion_info->self_exam_info[0], 0) ): \
        printf("math: no exam\n");
    
    persion_info->self_exam_info[ 1 ] ? \
        printf( "english: %d\n", persion_info->self_exam_info[1]-> \
        calc_score((void *)persion_info->self_exam_info[1], 0) ): \
        printf("english: no exam\n");
    
    persion_info->self_exam_info[ 2 ] ? \
        printf( "dota: %d\n", persion_info->self_exam_info[2]-> \
        calc_score((void*)persion_info->self_exam_info[2], 0) ): \
        printf("dota: no exam\n");

    printf("\n");
    
    return 0;
}

int do_resit()
{
    int idx;
    char s_idx[2] = {0};
    pexam_info pe_info = NULL;
    
    if( !is_register ){
        puts("you have to register firstly\n");
        return -1;
    }

    puts("which exam do you want to resit?");
    puts("1.math");
    puts("2.english");
    puts("3.dota");

    std_read(s_idx, 1);
    idx = std_atoi(s_idx, 1);

    if( idx<1 || idx >3 )
            goto cleanup;
    pe_info = persion_info->self_exam_info[idx-1];

    if( pe_info ){
        if( !pe_info->exam_contents ){
            puts("you have to take the exam firstly\n");
            goto cleanup;
        }
    }else{
        puts("you have to take the exam firstly\n");
        goto cleanup;
    }
    
    if( pe_info->calc_score((void *)pe_info, 1) > 60 ){
        puts("need not resit\n");
        goto cleanup;
    }else{
        if( pe_info->content_length ){
            pe_info->exam_contents = NULL;
            pe_info->content_length = 0;
        }
    }

    puts("OK, you could take the exam again\n");
    
    return 0;

cleanup:
    puts("something wrong...\n");
    return -1;
}

int do_cheat()
{

    puts("here you can cheat :)");
    if( !is_register ){
        puts("but you have to register firstly :(\n");
        return -1;
    }
    
    int idx;
    char s_idx[2] = {0};
    pexam_info pe_info = NULL;

    std_read(s_idx, 1);
    idx = std_atoi(s_idx, 1);

    if(idx < 1 || idx >3)
        return -1;

    pe_info = persion_info->self_exam_info[idx-1];

    if(pe_info){
        if(pe_info->exam_contents)
            std_read(pe_info->exam_contents, pe_info->content_buf_length);
    }
    
    return 0;
}

int main()
{
    int i, idx;
    char s_idx[5] = {0};

    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdin, NULL, _IONBF, 0);
    
    output_banner();
    
    while(1)
    {
        output_choice();

        std_read(s_idx,4);
        idx = std_atoi(s_idx, 4);

        switch(idx){
        case 1:
            do_register();
            break;
        case 2:
            take_exam();
            break;
        case 3:
            show_score();
            break;
        case 4:
            show_info();
            break;
        case 5:
            do_resit();
            break;
        case 1024:
            do_cheat();
            break;
        case 6:
            do_exit();
        default:
            puts("invalid input\n");

        }

    }
    return 0;
}
